{% extends "base.html" %}

{% block titleExtra %} | Home {% endblock %}

{% block scriptfn %}
<script type="text/javascript">
$(function() { 
    jQuery(".tagManager").tagsManager({
        preventSubmitOnEnter: false,
        typeahead: true,
        typeaheadAjaxSource: null,
        typeaheadSource: ["Princeton", "Family", "Friends"],
        blinkBGColor_1: '#FFFF9C',
        blinkBGColor_2: '#CDE69C',
    });
});</script>
<script type="text/javascript">
$(function() {
        $('#home_nav_button').addClass('current-page');
        $('#profile_nav_button').removeClass('current-page');
        $('#search_nav_button').removeClass('current-page');
        $('#login_nav_button').removeClass('current-page');
    });
</script>

<script type="text/javascript">
function submitOnRecClick(recaddform) {
    document.forms[recaddform].submit();
}
</script>

<script type="text/javascript">
function submitOnCheckClick(recaddform) {
    document.forms[recaddform].submit();
}
</script>

<script type="text/javascript">
function submitOnTrashClick(recaddform) {
    document.forms[recaddform].submit();
}
</script>
<script type="text/javascript">
function fb_connect() {
    document.forms['getFBinfo'].submit();
};
</script>
{% endblock %}

{% block bodyscripts %}
       <script>
       window.fbAsyncInit = function() {
        // init the FB JS SDK
        FB.init({
          appId      : '480528945353541',    // App ID from the app dashboard
          channelURL : 'buckitapp.herokuapp.com/channel.html',
          status     : true,                 // Check Facebook Login status
          cookie     : true,                 // Enable cookies to allow the server to access the session
          xfbml      : true                  // Look for social plugins on the page
          oauth      : true
    });
    };
    
    /* Capture Events */
    var tmp_userID = '', tmp_signedRequest = '', tmp_expiresIn = '', tmp_accessToken = '';
    FB.Event.subscribe('auth.login', function(response) {

        if (response.authResponse) { userLoggedIn(); }
    });
    FB.Event.subscribe('auth.logout', function(response) {
        /* Some action to perform when the user logs out via the "fb:login-button" displaying "Facebook Logout" on your webpage */
        userLoggedOut();
    });
    FB.getLoginStatus(function(response) {
        /* This is executed on load of the "App" (your webpage) in the event the user has already logged into FB */
        if (response.status === 'not_authorized') {
            /* The user has already logged into FB but not authorized the "App" (your webpage) */
        }
        else if (response.status === 'connected') {
            /* The user has logged into FB and authorized the "App" (your webpage) to get their user information */
            tmp_userID = response.authResponse.userID;
            tmp_signedRequest = response.authResponse.signedRequest;
            tmp_expiresIn = response.authResponse.expiresIn;
            tmp_accessToken = response.authResponse.accessToken;
            processUserInformation();
        }
    else { /* The user has not yet logged into FB */ }
});

    /* Handle Events */
    function userLoggedIn() {
        /* Triggered after user successfully logs into Facebook with their account from the "App" (your webpage) */
        /* Forward to "processUserInformation()" unless something unique needs to be done */
        processUserInformation();
    }
    function userLoggedOut() {
        /* User has initiated a logout from Facebook using the "fb:login-button" button from the "App" (your webpage) */
    }
    function processUserInformation() {
        /* Get the user's information to put into the webpage since the user is logged into FB and authorized the "App" (your webpage) */
        FB.api('/me', function(response) {
            document.getElementById('fbid').value = response.authResponse.userID;
        });

        FB.api('/me/picture', function(response) {
            var fbPic = response.data.url;
            document.getElementById('fbpic').value= fbPic;  
        });

        FB.api('/me/friends', function(response) {
           var friendIDs = '';
           for (i = 0; i < response.data.length; i++)
           {
               friendIDs = friendsIDs + response.data[i].id + ',';                      
           }
           document.getElementById('friendids').value = friendIDs;
       });

    };

    function login() {
      FB.login(function(response) {
         if (response.authResponse){
            // logged in
        } else {
            // cancelled
        }
  });
  };   

// Load the SDK Asynchronously
(function(d, s, id){
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script>
{% endblock %}

{% block grayBlock %}
    <div class="page-title">
        <div class="container">
            <div class="row buckit_blue">
                    <h1 class="span1">
                        {% if userpic == None %}
                        <i class="icon-user page-title-icon"></i>
                        {% else %}
                        <img src="{{userpic}}"/>
                        {% endif %}
                    </h1>
                    <h1 class="span5">{{name}}</h1>
            </div>
        </div>
        <form name = "getFBinfo" action="." method="POST">{% csrf_token %}
        	<input id="fbid" type="hidden" name="facebookid"/>
        	<input id="fbpic" type="hidden" name="facebookpic"/>
        	<input id="friendids" type="hidden" name="facebookfriends"/>
        </form>	
    </div>
    
{% endblock %}

{% block Content %}
<div class="container">
    <div class="row">
        <div class="span7"> 
            <div class="row">
                <h2>My BuckIt List</h2>
            </div>
            <div class="row">
                <div class="add-task">
                    <div class="task-form">
                        <form name="taskform" class="form-inline" method="post" action=".">{% csrf_token %}
                            <input id="name" type="text" name="task" placeholder="Add a new task..."/>
                            <input type="text" name="tags" placeholder="Add tags..." class="tagManager"/>
                            <button type="submit" name="addTask"> + </button>
                        </form>
                    </div>
                </div>
            </div>
            <script type="text/javascript">
            document.forms['taskform'].elements['task'].focus();
            </script>
            <div class="row">

                <table class="table">
                    <tr class="tableTitle">
                        <td class="tableTitle"></td>
                        <td>Task</td>
                        <td>Day Added</td>
                        <td>Day Completed</td>
                        <td>Tags</td>
                    </tr>
                    <tr>
                     {% for own in owns %}
                     <tr>
                        {% if own.completed %}
                        <td><form id="{{own.task.task_text}}-check" name="{{own.task.task_text}}-checktask" method="POST" action=".">
                            {% csrf_token %}
                            <input type="hidden" value="{{own.task.task_text}}" id="taskInfo" name="checkInfo"/>
                            <i class="icon-check" onClick="submitOnCheckClick('{{own.task.task_text}}-check');" name="check_submit" style="color:red;"></i>
                        </form></td>
                        {% else %}
                        <td><form id="{{own.task.task_text}}-check" name="{{own.task.task_text}}-checktask" method="POST" action=".">
                            {% csrf_token %}
                            <input type="hidden" value="{{own.task.task_text}}" id="taskInfo" name="checkInfo"/>
                            <input type="checkbox" id="check_submit" onClick="submitOnCheckClick('{{own.task.task_text}}-check');" name="check_submit"/>
                        </form>
                        </td>
                        {% endif %}
                         <td>{{own.task.task_text}}</td>
                         <td>{{own.date_set}}</td>
                         {% if own.completed %}
                         <td>{{own.date_done}}</td>
                         {% else %}
                         <td></td>
                         {% endif %}
                         <td>
                            {% for tag in own.task.tags.all %}
                            #{{tag.tag_text}}</br>
                            {% endfor %}</td>
                            <td><form id="{{own.task.task_text}}-trash" name="{{own.task.task_text}}-trashtask" method="POST" action=".">
                                {% csrf_token %}
                                <input type="hidden" value="{{own.task.task_text}}" id="trashInfo" name="trashInfo"/>
                                <i class="icon-trash" onClick="submitOnTrashClick('{{own.task.task_text}}-trash');" name="trash_submit"></i>
                            </form></td>

                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
        <div class="container offset1 span4">
                <div class="row  rec_title">
                    <h4>Add Recommended Task:</h4>
                </div>
                <div class="row rec_title form-inline">
                    {% for task in topTasks %}
                    <div>
                        <form id="{{task.task_text}}-form" name="recsubmit" method="POST" action=".">
                            {% csrf_token %}
                            <input type="hidden" value="{{task.task_text}}" id="taskInfo" name="recInfo"/>
                            <a id="submitrec" onclick="submitOnRecClick('{{task.task_text}}-form');" name="recsubmit">
                                <div class="rec span1">
                                    <p>{{task.task_text}}</p>
                                </div>
                            </a>
                        </form>
                        </div> 
                    {% endfor %}
                    <div>
                    <a href="/search/">
                        <div class="rec span1">
                            <p>Search for more tasks!</p>
                        </div>
                    </a>
                </div>
                </div>
            <div class="newsfeed">
                <div class ="row">
                    <div class ="news">
                        <h4>News Feed</h4>
                        <div class="icon-awesome pull-right"><h4>

<fb:login-button autologoutlink='true'></fb:login-button>
                            <button class="login" onclick="fb_connect()" title="Click to connect with facebook and update newsfeed"><i class="icon-facebook-sign"></i> CONNECT</button></h4> 
                        </div>
                    </div>
                </div>
		{% if friendNews %}
                {% for event in friendNews%}
                <div class="row">
                    <div class="news">
                        <img src="static/img/portfolio/work1.jpg" alt="">
                        {% if event.completed %}
                        <p>{{event.date_done}}<br>{{event.userProfile}} completed {{event.task}}</p>
                        {% else %}
                        <p>{{event.date_set}}<br>{{event.userProfile}} completed {{event.task}}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="row" style="background-color:#f8f8f8">
                    <h4> Click to allow access to facebook and see what your friends have been up to on BuckIt</h4>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block delete_account %}
<form method="POST" action="." id="deleteform" name="deleteform"> 
    {% csrf_token %}
    <h5>Click <a name="delete_account" onClick="confirmation()">here</a> to delete account.</h5>
    <input type="hidden" id="delete_account" name="delete_account"/>
</form>
{% endblock %}